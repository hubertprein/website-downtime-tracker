<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Website Downtime Tracker</title>
  <meta name="description" content="Offline-first tracker for downtime incidents with EUR currency, localized separators, JSON import/export, and incident timelines (with optional per-event dates)." />
  <style>
    :root{
      --bg:#0b0f14; --panel:#121821; --panel-2:#0f141c; --text:#e8eef6; --muted:#9fb2c7;
      --accent:#6ee7b7; --accent-2:#60a5fa; --danger:#f87171; --warn:#fbbf24; --success:#34d399; --border:#223041; --shadow:0 10px 30px rgba(0,0,0,.35); --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background: radial-gradient(1200px 800px at 10% -10%, #152033 0%, #0b0f14 40%, #0b0f14 100%); color:var(--text)}
    header{position:sticky; top:0; z-index:2; backdrop-filter: blur(8px); background: linear-gradient(180deg, rgba(11,15,20,.9), rgba(11,15,20,.6)); border-bottom:1px solid var(--border)}
    .wrap{max-width:1100px; margin:0 auto; padding:20px}
    .title{display:flex; align-items:center; gap:14px}
    h1{margin:0; font-size: clamp(20px, 2.6vw, 32px)}
    .badge{font-size:12px; padding:4px 8px; border:1px solid var(--border); border-radius:999px; color:var(--muted)}
    .controls{display:flex; flex-wrap:wrap; gap:10px; margin-top:14px}
    button, input, select, textarea{background: var(--panel); color: var(--text); border:1px solid var(--border); border-radius:12px; padding:10px 12px; font-size:14px}
    button{cursor:pointer}
    button.primary{background: linear-gradient(180deg, #1e293b, #0f172a); border-color:#1f2a3a}
    button.accent{background: linear-gradient(180deg, #133024, #0f271d); border-color:#1f3b2c}
    button:hover{filter:brightness(1.06)}
    button:active{transform: translateY(1px)}
    main{display:grid; grid-template-columns: 1fr; gap:20px; padding:20px}
    .card{background: linear-gradient(180deg, var(--panel), var(--panel-2)); border:1px solid var(--border); box-shadow: var(--shadow); border-radius: var(--radius)}
    .card .head{padding:16px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between}
    .card .body{padding:16px}
    .muted{color:var(--muted)}
    .grid{display:grid; grid-template-columns: repeat(6,1fr); gap:10px}
    .grid .full{grid-column:1/-1}
    .grid label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
    .table{width:100%; border-collapse: collapse}
    .table th, .table td{ padding:10px 8px; border-bottom:1px solid var(--border); text-align:left; vertical-align: top }
    .table th{font-size:12px; color:var(--muted); font-weight:600}
    .pill{padding:.2rem .6rem; border-radius:999px; border:1px solid var(--border); background:#0c131d; font-size:12px}
    .pill.warn{border-color:#6b4f16; background:#1a1306; color:#ffd37a}
    .pill.danger{border-color:#6b1f1f; background:#1a0b0b; color:#ffb4b4}
    .pill.ok{border-color:#175e3a; background:#0b1a12; color:#9ff2cd}
    .flex{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .stat-grid{display:grid; grid-template-columns: repeat(4, 1fr); gap:12px}
    @media (max-width: 620px){ .stat-grid{grid-template-columns: repeat(2, 1fr)} }
    .stat{padding:14px; border-radius:14px; background: linear-gradient(180deg, #0e1520, #0d1117); border:1px solid var(--border)}
    .stat .label{font-size:12px; color:var(--muted)}
    .stat .value{font-size:22px; font-weight:700; margin-top:6px}
    .events-head{display:flex; align-items:center; justify-content:space-between; margin:2px 0 8px}
    .event-row{display:grid; grid-template-columns: 150px 120px 1fr auto; gap:8px; align-items:center}
    .events-list{border:1px dashed var(--border); border-radius:12px; padding:10px}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="title">
      <h1>Website Downtime Tracker</h1>
      <span class="badge">Offline-first • GitHub Pages</span>
    </div>
    <div class="controls">
      <button id="addSample">Add sample data</button>
      <button id="exportBtn" class="accent">Export JSON</button>
      <input type="file" id="importFile" accept="application/json" style="display:none"/>
      <button id="importBtn">Import JSON</button>
      <button id="clearBtn">Clear all</button>
      <span class="muted">EUR fixed • Data saved locally (localStorage)</span>
    </div>
  </div>
</header>

<main class="wrap">
  <section class="card" style="grid-column: 1/-1">
    <div class="head"><strong>Add / Edit Incident</strong></div>
    <div class="body">
      <form id="incidentForm">
        <input type="hidden" id="rowId"/>
        <div class="grid">
          <div style="grid-column: span 2">
            <label for="date">Incident date</label>
            <input type="date" id="date" required />
          </div>
          <div style="grid-column: span 2">
            <label for="revenue">Loss of revenue (€)</label>
            <input type="number" id="revenue" min="0" step="0.01" />
          </div>
          <div style="grid-column: span 2">
            <label for="calcDuration">Calculated duration (minutes)</label>
            <input type="number" id="calcDuration" readonly />
          </div>
          <div class="full">
            <label for="learnings">Learnings / Root cause / Notes</label>
            <textarea id="learnings" rows="3" style="width:100%"></textarea>
          </div>
          <div class="full">
            <div class="events-head">
              <strong>Incident timeline (required for duration)</strong>
              <div class="muted">Option B+ — Enter <strong>time</strong> (HH:MM) and optionally a <strong>date</strong> for each event. If date is empty, the incident date is used.</div>
            </div>
            <div class="events-list" id="eventsList"></div>
            <div style="margin-top:8px" class="flex">
              <button type="button" id="addEventBtn">+ Add event</button>
              <button type="button" id="addNowBtn">+ Add event @ now</button>
              <span class="muted">Duration uses the earliest and latest timeline timestamps (dates allowed).</span>
            </div>
          </div>
          <div class="full flex" style="justify-content:flex-end; gap:10px">
            <button type="button" id="resetBtn">Reset</button>
            <button type="submit" class="primary">Save Incident</button>
          </div>
        </div>
      </form>
      <small class="muted">If any event has a date, it overrides the incident date for that row.</small>
    </div>
  </section>

  <section class="card" style="grid-column: 1/-1">
    <div class="head"><strong>Incidents</strong></div>
    <div class="body">
      <table class="table" id="table">
        <thead>
          <tr>
            <th style="width:260px">Timing</th>
            <th style="width:150px">Revenue loss (€)</th>
            <th>Learnings + Timeline</th>
            <th style="width:220px">Actions</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      <div id="empty" class="muted" style="padding:8px 2px; display:none">No incidents yet.</div>
    </div>
  </section>

  <section class="card" style="grid-column: 1/-1">
    <div class="head"><strong>Metrics</strong></div>
    <div class="body">
      <div class="stat-grid">
        <div class="stat"><div class="label">Total incidents</div><div class="value" id="statIncidents">0</div></div>
        <div class="stat"><div class="label">Total downtime</div><div class="value" id="statDowntime">0m</div></div>
        <div class="stat"><div class="label">MTTR</div><div class="value" id="statMTTR">–</div></div>
        <div class="stat"><div class="label">Total revenue loss</div><div class="value"><span style="font-weight:bold; margin-right:4px">€</span><span id="statRevenue">0,00</span></div></div>
      </div>
    </div>
  </section>
</main>

<script>
(function(){
  const LS_KEY = 'downtimeLog_v5'; // schema supports per-event optional date
  const currency = new Intl.NumberFormat('de-DE', { style:'decimal', minimumFractionDigits:2, maximumFractionDigits:2 });

  // DOM
  const tbody = document.getElementById('tbody');
  const form = document.getElementById('incidentForm');
  const rowId = document.getElementById('rowId');
  const dateEl = document.getElementById('date');
  const calcDurationEl = document.getElementById('calcDuration');
  const revenueEl = document.getElementById('revenue');
  const learningsEl = document.getElementById('learnings');
  const eventsList = document.getElementById('eventsList');
  const addEventBtn = document.getElementById('addEventBtn');
  const addNowBtn = document.getElementById('addNowBtn');
  const statIncidents = document.getElementById('statIncidents');
  const statDowntime = document.getElementById('statDowntime');
  const statMTTR = document.getElementById('statMTTR');
  const statRevenue = document.getElementById('statRevenue');

  // Data
  function save(){ localStorage.setItem(LS_KEY, JSON.stringify(data)); }
  function load(){ try{ const raw = localStorage.getItem(LS_KEY); return raw? JSON.parse(raw) : {entries:[]}; }catch(e){ return {entries:[]} } }
  let data = load();

  // Utils
  function fmtDT(d){ return new Intl.DateTimeFormat(undefined,{year:'numeric',month:'short',day:'2-digit', hour:'2-digit', minute:'2-digit'}).format(d); }
  function fmtDuration(min){ if(min==null||isNaN(min)) return '–'; const h=Math.floor(min/60), m=Math.round(min%60); return (h? h+'h ':'')+m+'m'; }
  function fmtMoney(n){ return currency.format(Number(n||0)); }
  function esc(s){ return String(s).replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }
  function renderLearnings(s){ return esc(s||'').replace(/\n/g,'<br>'); }
  function parseHHMM(hhmm){ if(!/^\d{2}:\d{2}$/.test(hhmm||'')) return null; const [h,m]=hhmm.split(':').map(n=>parseInt(n,10)); if(h>23||m>59) return null; return h*60+m; }
  function hhmm(min){ min=Math.max(0,min|0); const h=Math.floor(min/60), m=min%60; return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`; }
  function combineDateTime(dateStr, hhmmStr){ const [y,mo,da]=dateStr.split('-').map(n=>parseInt(n,10)); const [h,mi]=hhmmStr.split(':').map(n=>parseInt(n,10)); return new Date(y, mo-1, da, h, mi, 0, 0); }
  function toISODate(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }

  function eventToDate(ev, fallbackDate){
    const dStr = (ev.date && /^\d{4}-\d{2}-\d{2}$/.test(ev.date)) ? ev.date : (fallbackDate||'');
    const m = parseHHMM(ev.time);
    if(!dStr || m==null) return null;
    return combineDateTime(dStr, ev.time);
  }

  // Timeline UI helpers (Option B+: time + optional date per event)
  function addEventRow(hhmmVal = '', note = '', dateVal = ''){
    const row = document.createElement('div');
    row.className = 'event-row';
    row.innerHTML = `
      <input type="date" class="event-date" value="${dateVal}" />
      <input type="time" step="60" class="event-time" value="${hhmmVal}" />
      <input type="text" class="event-note" placeholder="What happened?" value="${esc(note)}" />
      <button type="button" class="event-del">Remove</button>
    `;
    row.querySelector('.event-del').addEventListener('click', ()=>{ row.remove(); calcDurationFromTimeline(); });
    const dateInput=row.querySelector('.event-date');
    const timeInput=row.querySelector('.event-time');
    const noteInput=row.querySelector('.event-note');
    dateInput.addEventListener('input', calcDurationFromTimeline);
    timeInput.addEventListener('input', calcDurationFromTimeline);
    noteInput.addEventListener('input', ()=>{});
    eventsList.appendChild(row);
  }

  function getEventsFromForm(){
    const rows = Array.from(eventsList.querySelectorAll('.event-row'));
    const events = rows.map(r=>{
      const dVal = r.querySelector('.event-date')?.value || '';
      const tVal = r.querySelector('.event-time')?.value || '';
      const noteVal = r.querySelector('.event-note')?.value.trim() || '';
      if(!tVal && !noteVal && !dVal) return null;
      return { date: dVal, time: tVal, note: noteVal };
    }).filter(Boolean);
    // sort by absolute datetime (fall back to incident date if missing)
    const base = dateEl.value;
    events.sort((a,b)=>{
      const ad = eventToDate(a, base); const bd = eventToDate(b, base);
      return (ad?ad.getTime():0) - (bd?bd.getTime():0);
    });
    return events;
  }

  function setEventsInForm(events){
    eventsList.innerHTML='';
    (events||[]).forEach(ev=> addEventRow(ev.time||'', ev.note||'', ev.date||''));
    calcDurationFromTimeline();
  }

  function calcDurationFromTimeline(){
    const base = dateEl.value || '';
    const events = getEventsFromForm();
    const dts = events.map(ev=>eventToDate(ev, base)).filter(Boolean);
    if(dts.length<2){ calcDurationEl.value = 0; return 0; }
    const first = new Date(Math.min(...dts.map(d=>d.getTime())));
    const last  = new Date(Math.max(...dts.map(d=>d.getTime())));
    const minutes = Math.max(0, Math.round((last - first)/60000));
    calcDurationEl.value = minutes;
    return minutes;
  }

  function render(){
    tbody.innerHTML='';
    const entries = [...data.entries].sort((a,b)=> {
      // sort by earliest event datetime desc, fallback to date string
      const baseA = a.date||''; const baseB=b.date||'';
      const aFirst = (a.events||[]).map(ev=>eventToDate(ev, baseA)).filter(Boolean).map(d=>d.getTime());
      const bFirst = (b.events||[]).map(ev=>eventToDate(ev, baseB)).filter(Boolean).map(d=>d.getTime());
      const aKey = aFirst.length? Math.min(...aFirst) : (baseA? new Date(baseA).getTime(): 0);
      const bKey = bFirst.length? Math.min(...bFirst) : (baseB? new Date(baseB).getTime(): 0);
      return bKey - aKey;
    });
    document.getElementById('empty').style.display = entries.length? 'none':'block';
    for(const e of entries){
      const base = e.date||'';
      const dts = (e.events||[]).map(ev=>eventToDate(ev, base)).filter(Boolean);
      const firstDT = dts.length? new Date(Math.min(...dts.map(d=>d.getTime()))) : null;
      const lastDT  = dts.length? new Date(Math.max(...dts.map(d=>d.getTime()))) : null;
      const duration = (firstDT && lastDT)? Math.max(0, Math.round((lastDT-firstDT)/60000)) : (e.duration||0);
      const pillClass = duration>180? 'pill danger' : duration>60? 'pill warn' : 'pill ok';
      const eventsHtml = (e.events && e.events.length)
        ? (()=>{ const list=e.events
              .slice()
              .sort((a,b)=>{
                const ad=eventToDate(a, base); const bd=eventToDate(b, base);
                return (ad?ad.getTime():0)-(bd?bd.getTime():0);
              })
              .map(x=>`<li><span class="muted">${esc(x.date||base||'')} ${esc(x.time||'')} — </span>${esc(x.note||'')}</li>`).join('');
            return `<details><summary>${e.events.length} event${e.events.length>1?'s':''}</summary><ol style="margin:6px 0 0 18px">${list}</ol></details>`; })()
        : '<span class="tag muted">No events</span>';
      const startCell = firstDT? fmtDT(firstDT) : '–';
      const endCell = lastDT? fmtDT(lastDT) : '–';
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>
          <div><strong>Start:</strong> ${startCell}</div>
          <div><strong>End:</strong> ${endCell}</div>
          <div><strong>Duration:</strong> <span class="${pillClass}">${fmtDuration(duration)}</span></div>
        </td>
        <td>€ ${fmtMoney(e.revenue)}</td>
        <td>${renderLearnings(e.learnings)}<div style="margin-top:6px">${eventsHtml}</div></td>
        <td><div class="flex">
          <button data-id="${e.id}" data-act="edit">Edit</button>
          <button data-id="${e.id}" data-act="dup">Duplicate</button>
          <button data-id="${e.id}" data-act="md">Copy MD</button>
          <button data-id="${e.id}" data-act="pm">Postmortem</button>
          <button data-id="${e.id}" data-act="del" style="color:#ffb4b4">Delete</button>
        </div></td>`;
      tbody.appendChild(row);
    }
    updateStats();
  }

  function updateStats(){
    const totals = data.entries.reduce((acc, r)=>{
      const base=r.date||'';
      const dts=(r.events||[]).map(ev=>eventToDate(ev, base)).filter(Boolean).map(d=>d.getTime());
      const d = dts.length>1? Math.round((Math.max(...dts)-Math.min(...dts))/60000) : 0;
      acc.minutes += d;
      acc.revenue += (Number(r.revenue)||0);
      return acc;
    },{minutes:0,revenue:0});
    const count=data.entries.length;
    statIncidents.textContent=count;
    statDowntime.textContent=fmtDuration(totals.minutes);
    statMTTR.textContent=count?fmtDuration(Math.round(totals.minutes/Math.max(1,count))):'–';
    statRevenue.textContent=fmtMoney(totals.revenue);
  }

  // ---- Postmortem generation ----
  function computeIncidentTimes(entry){
    const base=entry.date||'';
    const dts=(entry.events||[]).map(ev=>eventToDate(ev, base)).filter(Boolean).map(d=>d.getTime());
    if(dts.length<2) return {start:null,end:null,duration:0};
    const startMs=Math.min(...dts), endMs=Math.max(...dts);
    return { start:new Date(startMs), end:new Date(endMs), duration: Math.max(0, Math.round((endMs-startMs)/60000)) };
  }

  function buildPostmortemHTML(entry){
    const {start,end,duration}=computeIncidentTimes(entry);
    const startStr=start? fmtDT(start): '–';
    const endStr=end? fmtDT(end): '–';
    const safeLearn=renderLearnings(entry.learnings||'');
    const base=entry.date||'';
    const eventsHTML = (entry.events||[])
      .slice()
      .sort((a,b)=>{
        const ad=eventToDate(a, base); const bd=eventToDate(b, base);
        return (ad?ad.getTime():0)-(bd?bd.getTime():0);
      })
      .map(ev=>`<tr><td style="white-space:nowrap">${esc(ev.date||base||'')} ${esc(ev.time||'--:--')}</td><td>${esc(ev.note||'')}</td></tr>`)
      .join('');

    const html = [
      '<!DOCTYPE html><html><head><meta charset="utf-8"><title>Postmortem ', esc(entry.date||''), '</title>',
      '<style>',
      ':root{ --border:#d9dee7 }',
      'body{font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;margin:0;padding:24px;background:#ffffff;color:#0b1220}',
      '.card{background:#ffffff;border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:16px}',
      'h1,h2{margin:.2rem 0 .6rem} h1{font-size:22px} h2{font-size:16px;color:#1f2937}',
      'table{width:100%;border-collapse:collapse} td,th{border-bottom:1px solid var(--border);padding:8px 6px;text-align:left}',
      '.btns{display:flex;gap:8px;margin-bottom:12px}',
      'button{background:#1e293b;border:1px solid #223041;border-radius:10px;color:#e8eef6;padding:8px 10px;cursor:pointer}',
      '@media print{ .btns{display:none} }',
      '@page{ margin: 16mm }',
      '</style></head><body>',
      '<div class="btns"><button onclick="window.print()">Print</button></div>',
      '<div class="card">',
        '<h1>Incident Postmortem — ', esc(entry.date||'Unknown date'), '</h1>',
        '<table>',
          '<tr><th style="width:160px">Start</th><td>', esc(startStr), '</td></tr>',
          '<tr><th>End</th><td>', esc(endStr), '</td></tr>',
          '<tr><th>Duration</th><td>', esc(fmtDuration(duration)), '</td></tr>',
          '<tr><th>Revenue loss</th><td>€ ', esc(fmtMoney(entry.revenue)), '</td></tr>',
        '</table>',
      '</div>',
      '<div class="card"><h2>Learnings / Root cause</h2><div>', safeLearn || '<span style="color:#6b7280">(none)</span>', '</div></div>',
      '<div class="card"><h2>Timeline</h2>',
        '<table><thead><tr><th style="width:160px">Date & Time</th><th>Event</th></tr></thead><tbody>',
          eventsHTML || '<tr><td colspan="2">(no events)</td></tr>',
        '</tbody></table>',
      '</div>',
      '</body></html>'
    ].join('');

    return html;
  }

  // ---- Markdown builder ----
  function buildIncidentMarkdown(entry){
    const {start,end,duration}=computeIncidentTimes(entry);
    const lines=[];
    lines.push(`# Incident Postmortem – ${entry.date || 'Unknown date'}`);
    lines.push('');
    lines.push('## Summary');
    lines.push(`- **Date:** ${entry.date||'-'}`);
    lines.push(`- **Start:** ${start? fmtDT(start): '-'}`);
    lines.push(`- **End:** ${end? fmtDT(end): '-'}`);
    lines.push(`- **Duration:** ${fmtDuration(duration)}`);
    lines.push(`- **Revenue loss:** € ${fmtMoney(entry.revenue)}`);
    lines.push('');
    lines.push('## Learnings / Root cause');
    lines.push(entry.learnings? entry.learnings : '_(none provided)_');
    lines.push('');
    lines.push('## Timeline');
    const base=entry.date||'';
    if(entry.events && entry.events.length){
      const evs = entry.events.slice().sort((a,b)=>{
        const ad=eventToDate(a, base); const bd=eventToDate(b, base);
        return (ad?ad.getTime():0)-(bd?bd.getTime():0);
      });
      for(const ev of evs){ lines.push(`- ${(ev.date||base||'')} ${ev.time || '--:--'} — ${ev.note||''}`); }
    } else {
      lines.push('_(no events)_');
    }
    lines.push('');
    lines.push('## Follow-ups');
    lines.push('- [ ] ');
    return lines.join('\n');
  }

  async function copyIncidentMarkdown(entry){
    const text = buildIncidentMarkdown(entry);
    try{
      if(navigator.clipboard && navigator.clipboard.writeText){
        await navigator.clipboard.writeText(text);
      } else {
        const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove();
      }
      alert('Markdown copied to clipboard');
    }catch(err){
      console.warn('Clipboard copy failed', err); alert('Could not copy to clipboard');
    }
  }

  function openPostmortemWindow(entry){
    const w=window.open('', '_blank');
    if(!w){ alert('Pop-up blocked. Please allow pop-ups to view the postmortem.'); return; }
    w.document.open();
    w.document.write(buildPostmortemHTML(entry));
    w.document.close();
  }

  // Events
  addEventBtn.addEventListener('click', ()=> addEventRow('', '', ''));
  addNowBtn.addEventListener('click', ()=>{
    const now = new Date();
    const v = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
    const d = dateEl.value || toISODate(now);
    addEventRow(v, '', d);
    calcDurationFromTimeline();
  });
  dateEl.addEventListener('input', calcDurationFromTimeline);

  form.addEventListener('submit', ev=>{
    ev.preventDefault();
    const id=rowId.value||Math.random().toString(36).slice(2,10);
    const dateVal=dateEl.value;
    const events=getEventsFromForm();
    const validTimes=events.map(e=> eventToDate(e, dateVal)).filter(Boolean);
    if(!dateVal){ alert('Please select the incident date'); return; }
    if(validTimes.length<2){ alert('Please add at least two timeline events with a valid date/time (date optional if incident date is set)'); return; }
    const first = new Date(Math.min(...validTimes.map(d=>d.getTime())));
    const last  = new Date(Math.max(...validTimes.map(d=>d.getTime())));
    const duration = Math.max(0, Math.round((last-first)/60000));
    const entry={ id, date: dateVal, duration, revenue:+revenueEl.value, learnings:learningsEl.value.trim(), events };
    const idx=data.entries.findIndex(x=>x.id===id);
    if(idx>-1) data.entries[idx]=entry; else data.entries.push(entry);
    save(); render(); form.reset(); eventsList.innerHTML=''; calcDurationEl.value=''; rowId.value='';
  });

  tbody.addEventListener('click', e=>{
    const b=e.target.closest('button'); if(!b) return;
    const id=b.dataset.id; const act=b.dataset.act;
    const row=data.entries.find(x=>x.id===id); if(!row) return;
    if(act==='edit'){
      rowId.value=row.id;
      dateEl.value=row.date||'';
      revenueEl.value=row.revenue||0;
      learningsEl.value=row.learnings||'';
      setEventsInForm(row.events||[]);
      window.scrollTo({top:0, behavior:'smooth'});
    }
    if(act==='md'){
      copyIncidentMarkdown(row);
    }
    if(act==='pm'){
      openPostmortemWindow(row);
    }
    if(act==='dup'){
      data.entries.push({...row, id: Math.random().toString(36).slice(2,10)}); save(); render();
    }
    if(act==='del'){
      if(confirm('Delete this incident?')){ data.entries=data.entries.filter(x=>x.id!==id); save(); render(); }
    }
  });

  document.getElementById('exportBtn').addEventListener('click',()=>{
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
    a.download='downtime-log.json'; a.click(); URL.revokeObjectURL(a.href);
  });

  document.getElementById('importBtn').addEventListener('click',()=>document.getElementById('importFile').click());
  document.getElementById('importFile').addEventListener('change',async ev=>{
    const file=ev.target.files[0]; if(!file) return;
    try{
      const json=JSON.parse(await file.text());
      if(!json || !Array.isArray(json.entries)) throw new Error('Invalid file');
      data=json; save(); render();
    }catch(err){ alert('Import failed: '+err.message); }
    ev.target.value='';
  });

  document.getElementById('clearBtn').addEventListener('click',()=>{
    if(confirm('This will permanently clear all incidents in this browser. Continue?')){ data={entries:[]}; save(); render(); }
  });

  document.getElementById('addSample').addEventListener('click',()=>{
    const today = new Date();
    const date = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
    const sampleEvents=[
      { date, time: '23:50', note: 'Night deploy started' },
      { date: toISODate(new Date(today.getFullYear(),today.getMonth(),today.getDate()+1)), time: '00:20', note: 'Recovered next day' }
    ];
    const validTimes=sampleEvents.map(e=>eventToDate(e, date)).filter(Boolean);
    const first = new Date(Math.min(...validTimes.map(d=>d.getTime())));
    const last  = new Date(Math.max(...validTimes.map(d=>d.getTime())));
    const duration = Math.max(0, Math.round((last-first)/60000));
    data.entries.push({ id: Math.random().toString(36).slice(2,10), date, duration, revenue: 2140.12, learnings: 'DB failover took too long.\nTune health checks.', events: sampleEvents });
    save(); render();
  });

  // Mini tests
  try{
    console.assert(fmtMoney(1234.56).includes('1.234,56'),'EU money format');
    console.assert(parseHHMM('00:00')===0 && parseHHMM('23:59')===1439, 'HH:MM parser');
    // same-day duration
    const sd = Math.max(0, (combineDateTime('2025-01-01','11:40') - combineDateTime('2025-01-01','10:05'))/60000);
    console.assert(sd===95,'Duration by timeline (same day)');
    // cross-day duration
    const cd = Math.max(0, (combineDateTime('2025-01-02','00:20') - combineDateTime('2025-01-01','23:50'))/60000);
    console.assert(cd===30,'Duration by timeline (cross day)');
    console.assert(renderLearnings('a\nb')==='a<br>b','Learnings newline render');
    // Postmortem/MD build tests
    const _pmSample = { id:'t1', date:'2025-01-01', revenue:1234.5, learnings:'L1\nL2', events:[{date:'2025-01-01',time:'23:50',note:'Start'},{date:'2025-01-02',time:'00:20',note:'End'}] };
    const _html = buildPostmortemHTML(_pmSample);
    console.assert(typeof _html==='string' && !_html.includes('${'), 'Postmortem HTML contains no raw ${}');
    const md=buildIncidentMarkdown(_pmSample);
    console.assert(md.includes('€') && md.includes('00:20'), 'Markdown includes euro and times');
    console.log('%cMini tests passed','color:#6ee7b7');
  }catch(err){ console.warn('Mini tests failed', err); }

  render();
})();
</script>
</body>
</html>
